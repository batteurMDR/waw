<!DOCTYPE html>
<html>
    <head>
        <title>Simple Map</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <link href="css/app.css" rel="stylesheet" type="text/css" />
        <meta charset="utf-8">
        <style>
          html, body, #map{
            height: 100%;
            margin: 0px;
            padding: 0px
          }
        </style>
    </head>
    <body>
        <section class="panel center"><div id="map"></div></section>  
        <section class="panel right"></section>  
        <script type="text/javascript" src="js/jquery.js"></script>  
        <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyDNUjNpYK02xDNViii6SR6fLRZJXbCyIlg"></script>
        <script type="text/javascript" src="http://socket.whereandwhere.com:3426/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="js/app.js"></script>
        <script type="text/javascript">
        var me = [];
        function getQuerystring(key, default_) {
           if (default_==null) default_="";
           key = key.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
           var regex = new RegExp("[\\?&]"+key+"=([^&#]*)");
           var qs = regex.exec(window.location.href);
           if(qs == null) return default_; else return qs[1];
        }
        wawapi.key = "408271ba8a705f930f09a930e1e6d7e6add2cd71";
        wawapi.secret = "bb868f16eb82823946924036aef1fe10";
        wawapi.token = getQuerystring('token');
        var map;
        function initialize(){
            var mapOptions = {
                zoom: 16,
                disableDefaultUI: true,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
                }
            };
            map = new google.maps.Map(document.getElementById('map'),mapOptions);
        }
        google.maps.event.addDomListener(window,'load',initialize);

        $(function(){ 
            var socket = io.connect('http://socket.whereandwhere.com:3426');
            var users = {};
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(function(position){
                    var pos = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
                    me.lat = position.coords.latitude;
                    me.lng = position.coords.longitude;
                    wawapi.get("/users/data",function(data){
                        if(data.error){
                            alert(data.message);
                        }else{
                            me = data.data.user;
                            var contentContextual = '<div id="content" class="contextual" data-id="'+me.id+'">'+
                                '<a href="move_all">M\'animer</a>'+
                                '<a href="profile">Voir le profil</a>'+
                            '</div>';
                            me.marker = new google.maps.Marker({
                                position: pos,
                                map: map,
                                title: me.username,
                                animation: google.maps.Animation.DROP,
                                icon : "http://src.whereandwhere.com"+me.avatar
                            });
                            me.contextual = new google.maps.InfoWindow({
                                content: contentContextual
                            });
                            google.maps.event.addListener(me.marker, 'click', function() {
                                me.contextual.open(map,me.marker);
                                $('.contextual').each(function(){
                                    var user_id = $(this).data('id');   
                                    $(this).find('a').each(function(){
                                        var that = $(this);
                                        var action = that.attr('href');
                                        that.click(function(e){
                                            e.preventDefault();
                                            switch(action){
                                                case 'move' :
                                                    return false;
                                                    break;

                                                case 'move_all' : 
                                                    socket.emit('animateAll');
                                                    break;

                                                case 'profile' : 
                                                    $('.loader').fadeIn();
                                                    window.location = "/profile/"+user_id;
                                                    break;

                                                case 'chat' : 
                                                    return false;
                                                    break;
                                            }
                                            return false;
                                        });
                                    });
                                });
                            });
                            map.setCenter(pos);
                            socket.emit('newUser',{id:me.id,username:me.username,avatar:me.avatar,lat:me.lat,lng:me.lng});
                            getUserMove(socket);
                        }
                    });
                }, function() {
                    handleNoGeolocation(true);
                });
            }else{
                handleNoGeolocation(false);
            }

            socket.on('moveUser',function(user){
                var pos = new google.maps.LatLng(user.lat,user.lng);
                if(user.id==me.id){
                    me.marker.setPosition(pos);
                    map.setCenter(pos);
                }else{
                    users[user.id]["marker"].setPosition(pos);
                }
            });

            socket.on('animate',function(user){
                if(user.see==me.id){
                    if (users[user.move]["marker"].getAnimation() != null) {
                        users[user.move]["marker"].setAnimation(null);
                    }else{
                        users[user.move]["marker"].setAnimation(google.maps.Animation.BOUNCE);
                    }
                }
            });

            socket.on('animateAll',function(user){
                if (users[user.move]["marker"].getAnimation() != null) {
                    users[user.move]["marker"].setAnimation(null);
                }else{
                    users[user.move]["marker"].setAnimation(google.maps.Animation.BOUNCE);
                }
            });


            socket.on('newUser',function(user){
                if(user.id!=me.id){
                    users[user.id] = user;
                    var contentContextual = '<div id="content" class="contextual" data-id="'+user.id+'">'+
                        '<a href="move">M\'animer pour cette personne</a>'+
                        '<a href="profile">Voir le profil</a>'+
                        '<a href="chat">Parler avec cette personne</a>'+
                    '</div>';
                    var pos = new google.maps.LatLng(user.lat,user.lng);
                    users[user.id]["marker"] = new google.maps.Marker({
                        position: pos,
                        map: map,
                        title: user.username,
                        animation: google.maps.Animation.DROP,
                        icon : "http://src.whereandwhere.com"+user.avatar
                    });
                    users[user.id]["contextual"] = new google.maps.InfoWindow({
                        content: contentContextual
                    });
                    google.maps.event.addListener(users[user.id]["marker"], 'click', function() {
                        users[user.id]["contextual"].open(map,users[user.id]["marker"]);
                        $('.contextual').each(function(){
                            var user_id = $(this).data('id');   
                            $(this).find('a').each(function(){
                                var that = $(this);
                                var action = that.attr('href');
                                that.click(function(e){
                                    e.preventDefault();
                                    switch(action){
                                        case 'move' :
                                            socket.emit('animate',{id:user_id});
                                            break;

                                        case 'move_all' : 
                                            return false;
                                            break;

                                        case 'profile' : 
                                            $('.loader').fadeIn();
                                            window.location = "/profile/"+user_id;
                                            break;

                                        case 'chat' : 
                                            $('.center').removeClass('center').addClass('left');
                                            $('.right').removeClass('right').addClass('center');
                                            break;
                                    }
                                    return false;
                                });
                            });
                        });
                    });
                }
            });

            socket.on('remUser',function(user){
                users[user.id]["marker"].setMap(null);
                delete users[user.id];
            });

        }); 

        function handleNoGeolocation(errorFlag) {
            if(errorFlag){
                changePanel("error_geo");
            }else{
                changePanel("error_geo");
            }
        }

        function getUserMove(socket){
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(function(position){
                    if(me.lat!=position.coords.latitude&&me.lng!=position.coords.longitude){
                        var pos = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
                        me.lat = position.coords.latitude;
                        me.lng = position.coords.longitude;
                        map.setCenter(pos);
                        socket.emit('moveUser',{id:me.id,lat:me.lat,lng:me.lng});
                        getUserMove(socket);
                    }else{
                        getUserMove(socket);
                    }
                }, function() {
                    handleNoGeolocation(true);
                });
            }else{
                handleNoGeolocation(false);
            }
        }

        </script>
    </body>
</html>