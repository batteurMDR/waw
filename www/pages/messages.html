<section class="chats panel center"></section>
<section class="chat panel right padding">
	<form class="send" class="grid"><input type="text" name="message" placeholder="Votre message" class="col-s-8 col-m-8 col-l-10" AUTOCOMPLETE=OFF><input type="submit" value="Envoyer" class="col-s-4 col-m-4 col-l-2"></form><br><br><br>
	<div class="messages"></div>
</section>
<script type="text/javascript" src="http://socket.whereandwhere.com:3427/socket.io/socket.io.js"></script>
<script type="text/javascript">
	$(function(){
		wawapi.get("/chats/user/"+user.id,function(data){
			if(data.error){
				alert(data.message);
			}else{
				data.chats.forEach(function(d){
					wawapi.get("/chats/chat/"+d.id,function(infos){
						if(infos.error){
							alert(infos.message);
						}else{
							if(user.id==infos.data.owner_id){
  								var id = infos.data.user_id;
							}else{
								var id = infos.data.owner_id;
							}
							var users = wawapi.get("/users/user/"+id,function(users){
								var html = "<div class='chat' data-id='"+infos.data.id+"' data-user='"+id+"' onclick='openChat("+infos.data.id+","+id+")'><img src='http://src.whereandwhere.com"+users.data.user.avatar+"'><p>"+users.data.user.username+"</p></div>";
								$('.chats').append(html);
							});
						}
					});
				});
			}
		});
	});
	function openChat(id,users){
		$('.name').hide();
		$('.load').show();
		$('.loader').show();
		var socket = io.connect('http://socket.whereandwhere.com:3427');
		socket.emit('login',{id:user.id,username:user.username,avatar:user.avatar,chat:id,user:users});
		$('form.send').each(function(){
			var that = $(this);
			var message = [];
			that.submit(function(event){
				event.preventDefault();
				var input = that.find('input[name=message]');
				socket.emit('newMsg',{message:input.val(),chat:id});
				input.val("");
				input.focus();
			});
		});
		socket.on('newMsg',function(message){
			if(message.chat==id){
				if(user.id==message.user.id){
					var html = "<div class='message me'><p>"+message.message+"</p></div>";
				}else{;
					var html = "<div class='message'><p>"+message.message+"</p></div>";
				}
				$('.messages').prepend(html);
			}
		});	
		$('.center').removeClass('center').addClass('left');
		$('.right').removeClass('right').addClass('center');
		$('.load').hide();
		$('.loader').hide();
		$('.name').show();	
	}
</script>